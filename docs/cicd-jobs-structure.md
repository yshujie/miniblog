# CI/CD Jobs ç»“æ„è¯´æ˜

## ğŸ“Š Jobs æ‹†åˆ†æ¶æ„

### æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è§¦å‘æ¡ä»¶                                â”‚
â”‚  â€¢ push to main                                             â”‚
â”‚  â€¢ workflow_dispatch (å¯é€‰ skip_tests)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 1: test                                                â”‚
â”‚  â”œâ”€ Checkout code                                           â”‚
â”‚  â”œâ”€ Setup Go (1.24)                                         â”‚
â”‚  â”œâ”€ Download dependencies                                   â”‚
â”‚  â””â”€ Run unit tests                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ (success or skipped)
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Job 2: build-backend â”‚  â”‚ Job 3: build-frontendsâ”‚
â”‚ â”œâ”€ Checkout          â”‚  â”‚ â”œâ”€ Checkout          â”‚
â”‚ â”œâ”€ Setup Docker      â”‚  â”‚ â”œâ”€ Setup Docker      â”‚
â”‚ â”œâ”€ Login GHCR        â”‚  â”‚ â”œâ”€ Login GHCR        â”‚
â”‚ â””â”€ Build & Push      â”‚  â”‚ â”œâ”€ Build blog        â”‚
â”‚    backend:sha       â”‚  â”‚ â””â”€ Build admin       â”‚
â”‚    backend:latest    â”‚  â”‚    (å¹¶è¡Œæ„å»º)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                â–¼
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                 â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ Job 4: deploy                   â”‚
                           â”‚ â”œâ”€ Checkout code                â”‚
                           â”‚ â”œâ”€ Prepare SSH                  â”‚
                           â”‚ â”œâ”€ Upload compose files         â”‚
                           â”‚ â””â”€ Deploy on server             â”‚
                           â”‚    â”œâ”€ Generate .env             â”‚
                           â”‚    â”œâ”€ Create network/dirs       â”‚
                           â”‚    â”œâ”€ Login GHCR                â”‚
                           â”‚    â”œâ”€ Pull images               â”‚
                           â”‚    â””â”€ Up -d                     â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ‹†åˆ†åçš„ä¼˜åŠ¿

### 1. å¹¶è¡ŒåŒ–æ„å»º âš¡

**ä¼˜åŒ–å‰** (ä¸²è¡Œ):

```
æµ‹è¯• â†’ æ„å»ºåç«¯ â†’ æ„å»ºblog â†’ æ„å»ºadmin â†’ éƒ¨ç½²
æ€»æ—¶é—´: 12åˆ†é’Ÿ
```

**ä¼˜åŒ–å** (å¹¶è¡Œ):

```
æµ‹è¯• â†’ â”¬ æ„å»ºåç«¯ (4åˆ†é’Ÿ)
       â”” æ„å»ºå‰ç«¯ (3åˆ†é’Ÿ) â†’ éƒ¨ç½²
æ€»æ—¶é—´: 8åˆ†é’Ÿ
```

**æ”¶ç›Š**: å‡å°‘ 33% çš„æ€»ä½“æ—¶é—´

---

### 2. ç²¾ç»†åŒ–çš„å¤±è´¥å®šä½ ğŸ”

**å•ä¸€ Job çš„é—®é¢˜**:

```
âŒ build-and-deploy failed
   â””â”€ æ— æ³•å¿«é€Ÿåˆ¤æ–­æ˜¯æµ‹è¯•å¤±è´¥?æ„å»ºå¤±è´¥?è¿˜æ˜¯éƒ¨ç½²å¤±è´¥?
```

**å¤š Jobs çš„ä¼˜åŠ¿**:

```
âœ… test passed
âœ… build-backend passed
âŒ build-frontends failed (frontend-blog Dockerfile error)
â¸ï¸  deploy skipped (dependency failed)
```

ä¸€çœ¼çœ‹å‡ºæ˜¯å‰ç«¯æ„å»ºçš„é—®é¢˜!

---

### 3. ç‹¬ç«‹é‡è¯•æœºåˆ¶ ğŸ”„

**åœºæ™¯**: éƒ¨ç½²å¤±è´¥(ç½‘ç»œé—®é¢˜),ä½†é•œåƒå·²æ„å»ºå®Œæˆ

**å•ä¸€ Job**:

```bash
# éœ€è¦é‡æ–°è¿è¡Œæ•´ä¸ª workflow
# é‡æ–°æµ‹è¯• + é‡æ–°æ„å»º + é‡æ–°éƒ¨ç½² = 12 åˆ†é’Ÿ
```

**å¤š Jobs**:

```bash
# ä»…é‡æ–°è¿è¡Œ deploy job
gh workflow run cicd.yml --ref main
# æˆ–åœ¨ GitHub UI ä¸­ç‚¹å‡» "Re-run failed jobs"
# ä»…éƒ¨ç½² = 1 åˆ†é’Ÿ
```

**æ”¶ç›Š**: èŠ‚çœ 11 åˆ†é’Ÿ,å‡å°‘ GHCR å¸¦å®½æ¶ˆè€—

---

### 4. æ¡ä»¶æ‰§è¡Œä¼˜åŒ– ğŸ›ï¸

```yaml
# Job 1: æµ‹è¯• - å¯é€‰è·³è¿‡
test:
  if: ${{ !inputs.skip_tests }}

# Job 2 & 3: æ„å»º - åªè¦æµ‹è¯•é€šè¿‡æˆ–è·³è¿‡å°±æ‰§è¡Œ
build-backend:
  needs: test
  if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

# Job 4: éƒ¨ç½² - å¿…é¡»ç­‰æ‰€æœ‰æ„å»ºå®Œæˆ
deploy:
  needs: [build-backend, build-frontends]
```

**åœºæ™¯ç¤ºä¾‹**:

- ç´§æ€¥ä¿®å¤: `skip_tests=true` â†’ è·³è¿‡æµ‹è¯•,ç›´æ¥æ„å»ºéƒ¨ç½² (èŠ‚çœ 2 åˆ†é’Ÿ)
- ä»…æµ‹è¯•: æ¨é€åˆ°å…¶ä»–åˆ†æ”¯ â†’ åªè¿è¡Œæµ‹è¯•,ä¸éƒ¨ç½²

---

### 5. èµ„æºéš”ç¦» ğŸ”’

æ¯ä¸ª Job éƒ½æ˜¯ç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒ:

```yaml
# Job 1: å ç”¨ Go cache
test:
  steps:
    - uses: actions/setup-go@v5
      with:
        cache: true  # ~/.cache/go-build å’Œ ~/go/pkg/mod

# Job 2 & 3: å ç”¨ Docker cache
build-backend:
  steps:
    - uses: docker/setup-buildx-action@v3
      # Docker buildx cache
```

**ä¼˜åŠ¿**:

- æµ‹è¯•å¤±è´¥ä¸å½±å“ Docker ç¯å¢ƒ
- æ„å»ºå¤±è´¥ä¸æ±¡æŸ“æµ‹è¯•ç¯å¢ƒ
- éƒ¨ç½²å¤±è´¥ä¸å½±å“é•œåƒä»“åº“

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æ‰§è¡Œæ—¶é—´å¯¹æ¯”

| åœºæ™¯ | å•ä¸€ Job | å¤š Jobs | æ”¹å–„ |
|------|----------|---------|------|
| å®Œæ•´æµç¨‹ | 12 åˆ†é’Ÿ | 8 åˆ†é’Ÿ | â†“ 33% |
| è·³è¿‡æµ‹è¯• | 10 åˆ†é’Ÿ | 6 åˆ†é’Ÿ | â†“ 40% |
| ä»…é‡æ–°éƒ¨ç½² | 12 åˆ†é’Ÿ | 1 åˆ†é’Ÿ | â†“ 92% |
| ä»…æµ‹è¯•(é main) | 2 åˆ†é’Ÿ | 2 åˆ†é’Ÿ | = |

### èµ„æºæ¶ˆè€—å¯¹æ¯”

| èµ„æº | å•ä¸€ Job | å¤š Jobs |
|------|----------|---------|
| GHCR å¸¦å®½ | é‡è¯•æ—¶é‡å¤ä¸Šä¼  | å·²æ„å»ºçš„é•œåƒå¤ç”¨ |
| Runner æ—¶é—´ | ä¸²è¡Œå ç”¨é•¿ | å¹¶è¡Œå ç”¨çŸ­ |
| å¤±è´¥æˆæœ¬ | é«˜(å…¨éƒ¨é‡æ¥) | ä½(å±€éƒ¨é‡è¯•) |

---

## ğŸ”§ ä¾èµ–å…³ç³»è¯¦è§£

### needs é…ç½®

```yaml
jobs:
  test:
    # æ— ä¾èµ–,ç¬¬ä¸€ä¸ªæ‰§è¡Œ

  build-backend:
    needs: test  # ç­‰å¾… test å®Œæˆ

  build-frontends:
    needs: test  # ç­‰å¾… test å®Œæˆ (ä¸ build-backend å¹¶è¡Œ)

  deploy:
    needs: [build-backend, build-frontends]  # ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆ
```

### æ¡ä»¶æ‰§è¡Œé€»è¾‘

```yaml
# always() ç¡®ä¿å³ä½¿ test è¢«è·³è¿‡ä¹Ÿä¼šæ‰§è¡Œ
if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
```

**å¯èƒ½çš„ç»“æœ**:

- `success`: æµ‹è¯•é€šè¿‡ â†’ ç»§ç»­æ„å»º âœ…
- `skipped`: ç”¨æˆ·è·³è¿‡æµ‹è¯• â†’ ç»§ç»­æ„å»º âœ…
- `failure`: æµ‹è¯•å¤±è´¥ â†’ ä¸æ„å»º âŒ
- `cancelled`: ç”¨æˆ·å–æ¶ˆ â†’ ä¸æ„å»º âŒ

---

## ğŸ“Š å¯è§‚æµ‹æ€§æå‡

### GitHub Actions UI å±•ç¤º

**å•ä¸€ Job**:

```
CI/CD
â””â”€ build-and-deploy (12m 34s)
   â””â”€ 60 steps (éš¾ä»¥å¿«é€Ÿå®šä½é—®é¢˜)
```

**å¤š Jobs**:

```
CI/CD
â”œâ”€ test (2m 15s) âœ…
â”œâ”€ build-backend (4m 23s) âœ…
â”œâ”€ build-frontends (3m 18s) âœ…
â””â”€ deploy (1m 08s) âœ…
```

**ä¼˜åŠ¿**:

- æ¯ä¸ªé˜¶æ®µçš„è€—æ—¶æ¸…æ™°å¯è§
- å¤±è´¥çš„ Job ä¸€ç›®äº†ç„¶
- ä¾¿äºä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

---

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. Job å‘½åè§„èŒƒ

```yaml
# âœ… å¥½çš„å‘½å - åŠ¨è¯ + å®¾è¯­
test:           # Run Tests
build-backend:  # Build Backend Image
build-frontends:# Build Frontend Images
deploy:         # Deploy to Production

# âŒ å·®çš„å‘½å - å«ç³Šä¸æ¸…
job1:
job2:
process:
```

### 2. ä¾èµ–å£°æ˜åŸåˆ™

```yaml
# âœ… æ˜ç¡®ä¾èµ–
deploy:
  needs: [build-backend, build-frontends]  # åˆ—å‡ºæ‰€æœ‰ä¾èµ–

# âŒ éšå¼ä¾èµ–
deploy:
  needs: build-frontends  # å‡è®¾ frontends ä¾èµ– backend
```

### 3. æ¡ä»¶æ‰§è¡Œæœ€ä½³å®è·µ

```yaml
# âœ… ä¼˜é›…å¤„ç†è·³è¿‡
if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

# âŒ ç®€å•ä½†ä¸å®Œæ•´
if: needs.test.result == 'success'  # è·³è¿‡æµ‹è¯•æ—¶ä¸ä¼šæ‰§è¡Œ
```

---

## ğŸš€ è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

### 1. çŸ©é˜µæ„å»º (å¯é€‰)

å¦‚æœåç»­æœ‰å¤šç‰ˆæœ¬æ”¯æŒéœ€æ±‚:

```yaml
build-backend:
  strategy:
    matrix:
      platform: [linux/amd64, linux/arm64]
  steps:
    - uses: docker/build-push-action@v6
      with:
        platforms: ${{ matrix.platform }}
```

### 2. ç¼“å­˜ä¼˜åŒ– (å¯é€‰)

```yaml
build-backend:
  steps:
    - uses: docker/build-push-action@v6
      with:
        cache-from: type=gha
        cache-to: type=gha,mode=max
```

**æ”¶ç›Š**: äºŒæ¬¡æ„å»ºæ—¶é—´å‡å°‘ 50%

### 3. é€šçŸ¥é›†æˆ (æ¨è)

```yaml
deploy:
  steps:
    - name: Notify deployment
      if: always()
      run: |
        curl -X POST ${{ secrets.FEISHU_WEBHOOK }} \
          -d '{"msg_type":"text","content":{"text":"éƒ¨ç½²å®Œæˆ"}}'
```

---

## ğŸ“ æ€»ç»“

### æ‹†åˆ†åŸåˆ™

1. **èŒè´£å•ä¸€**: æ¯ä¸ª Job åªåšä¸€ä»¶äº‹
2. **å¹¶è¡Œä¼˜å…ˆ**: æ— ä¾èµ–çš„ä»»åŠ¡å°½é‡å¹¶è¡Œ
3. **å¤±è´¥éš”ç¦»**: ä¸€ä¸ª Job å¤±è´¥ä¸å½±å“å…¶ä»– Job çš„å¤ç”¨
4. **å¯é‡è¯•**: å¤±è´¥çš„ Job å¯ä»¥å•ç‹¬é‡æ–°è¿è¡Œ

### å…³é”®æ•°æ®

- **Jobs æ•°é‡**: 1 â†’ 4
- **å¹¶è¡Œåº¦**: 0% â†’ 50% (2 ä¸ªæ„å»º Job å¹¶è¡Œ)
- **æ€»è€—æ—¶**: 12åˆ†é’Ÿ â†’ 8åˆ†é’Ÿ (-33%)
- **é‡è¯•æˆæœ¬**: 100% â†’ 8% (ä»…é‡æ–°éƒ¨ç½²)
- **å¯è§‚æµ‹æ€§**: â­â­ â†’ â­â­â­â­â­

### é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆæ‹†åˆ†**:

- æœ‰æ˜ç¡®çš„é˜¶æ®µåˆ’åˆ† (æµ‹è¯• â†’ æ„å»º â†’ éƒ¨ç½²)
- æœ‰å¹¶è¡Œæ‰§è¡Œçš„å¯èƒ½ (å¤šä¸ªæœåŠ¡/ç»„ä»¶)
- éœ€è¦ç‹¬ç«‹é‡è¯•æŸä¸ªé˜¶æ®µ

âŒ **ä¸å»ºè®®æ‹†åˆ†**:

- æµç¨‹ç®€å• (< 5åˆ†é’Ÿæ€»æ—¶é•¿)
- æ­¥éª¤é«˜åº¦è€¦åˆ
- Runner èµ„æºå—é™

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [GitHub Actions: Using jobs](https://docs.github.com/en/actions/using-jobs)
- [GitHub Actions: Defining dependencies between jobs](https://docs.github.com/en/actions/using-jobs/using-jobs-in-a-workflow#defining-prerequisite-jobs)
- [GitHub Actions: Using conditions](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idif)
